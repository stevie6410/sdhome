# SDHome Angular + ASP.NET Core Integration

## ✅ Integration Complete!

Your Angular app is now integrated with ASP.NET Core. Here's how it works:

## Architecture

### Development Mode
- **Angular Dev Server**: `http://localhost:4200` (with hot reload)
- **ASP.NET Core API**: `https://localhost:5000`
- **Proxy**: Angular proxies `/api` and `/swagger` calls to the backend
- **No CORS issues**: Proxy handles cross-origin requests

### Production Mode
- **Single Server**: ASP.NET Core serves everything
- **Static Files**: Angular built files served from `wwwroot`
- **API Routes**: `/api/*` handled by controllers
- **SPA Fallback**: All other routes serve `index.html`

## How to Run

### Option 1: Development with Hot Reload (Recommended)

**Terminal 1 - Start ASP.NET Core API:**
```powershell
cd src/SDHome.Api
dotnet run
```
The API will run on `https://localhost:5000`

**Terminal 2 - Start Angular Dev Server:**
```powershell
cd src/ClientApp
npm start
```
The Angular app will open automatically at `http://localhost:4200`

**How it works:**
- Angular runs on port 4200 with hot reload
- API calls to `/api/*` are proxied to `https://localhost:5000`
- You can access Swagger at `http://localhost:4200/swagger`

### Option 2: Production Mode (Single Server)

**Build Angular:**
```powershell
cd src/ClientApp
npm run build:prod
```

**Run ASP.NET Core (serves both API and Angular):**
```powershell
cd src/SDHome.Api
dotnet run
```

Access everything at `https://localhost:5000`

## Using the API Client in Angular

The TypeScript client is automatically generated by NSwag. Here's how to use it:

### 1. Create a Service Component

```typescript
// src/app/signals/signals.component.ts
import { Component, OnInit } from '@angular/core';
import { SignalsClient } from '../api/sdhome-client';

@Component({
  selector: 'app-signals',
  template: `
    <h2>Recent Signals</h2>
    <div *ngFor="let signal of signals">
      {{ signal.eventId }} - {{ signal.timestamp }}
    </div>
  `
})
export class SignalsComponent implements OnInit {
  signals: any[] = [];

  constructor(private signalsClient: SignalsClient) {}

  ngOnInit() {
    this.signalsClient.getSignals(10, 0).subscribe({
      next: (data) => this.signals = data,
      error: (err) => console.error('Error fetching signals', err)
    });
  }
}
```

### 2. Provide the Client

The API client is already configured in `app.config.ts`:
- `provideHttpClient()` - Enables HTTP requests
- `API_BASE_URL` - Set to empty string (uses relative URLs with proxy)

## File Structure

```
src/
├── SDHome.Api/
│   ├── Program.cs              # SPA middleware configured here
│   ├── proxy.conf.json         # Proxy configuration
│   └── SDHome.Api.csproj       # SPA package + build targets
└── ClientApp/
    ├── proxy.conf.json         # Angular proxy config
    ├── package.json            # Updated start script
    └── src/
        └── app/
            ├── api/
            │   ├── sdhome-client.ts   # Generated TypeScript client
            │   └── api.config.ts      # API base URL config
            └── app.config.ts          # HttpClient + API_BASE_URL providers
```

## NSwag Integration

When you build the API project:
1. NSwag generates OpenAPI spec from your controllers
2. TypeScript client is generated in `ClientApp/src/app/api/sdhome-client.ts`
3. Angular can immediately use the updated client

To regenerate the client manually:
```powershell
cd src/SDHome.Api
dotnet build
```

## Next Steps

1. **Install Angular dependencies** (if not done):
   ```powershell
   cd src/ClientApp
   npm install
   ```

2. **Start development servers** (both terminals)

3. **Create components** to consume your API:
   - Signals dashboard
   - Sensor readings chart
   - Trigger management

4. **Add routing** in `app.routes.ts` for different views

5. **Consider adding**:
   - Authentication/Authorization
   - SignalR for real-time updates
   - Angular Material or other UI library
   - Charts for sensor data visualization

## Deployment

When you publish the application:
```powershell
cd src/SDHome.Api
dotnet publish -c Release -o ./publish
```

The build process will:
1. Run `npm install` in ClientApp
2. Build Angular with production optimizations
3. Copy Angular dist files to `wwwroot`
4. Package everything as a single deployable unit

## Troubleshooting

**Port conflicts:**
- Change Angular port in `package.json`: `"start": "ng serve --port 4300 --proxy-config proxy.conf.json"`

**Proxy not working:**
- Ensure ASP.NET Core API is running first
- Check `proxy.conf.json` target URL matches your API URL

**API client errors:**
- Rebuild API project to regenerate the client
- Check that `API_BASE_URL` is provided in `app.config.ts`
